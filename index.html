<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Super Detailed Face Reading Selector (Local Storage)</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons Library for aesthetics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1e293b;
      }
      .feature-card {
        min-height: 480px;
        /* Default transition for button/snap-back animations */
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        transform: translateX(0);
        backface-visibility: hidden;
        perspective: 1000px;
        cursor: grab; /* Visual cue for dragging */
      }
      .feature-card.is-dragging {
        transition: none !important; /* Disable transition while dragging */
        cursor: grabbing;
      }

      /* Entry/Exit Animations for Button Clicks or final snap (if needed) */
      .card-enter {
        opacity: 0;
        transform: translateX(100%);
      }
      .card-exit-left {
        opacity: 0;
        transform: translateX(-150%) rotate(-10deg);
      }
      .card-exit-right {
        opacity: 0;
        transform: translateX(150%) rotate(10deg);
      }

      .card-button {
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .card-button:active {
        transform: scale(0.95);
      }
      /* Custom image size for better card fit */
      .card-image {
        width: 100%;
        height: 300px; /* Fixed height for consistent look */
        object-fit: cover;
        object-position: center;
      }
      
      /* Scrollbar styling for reading results */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1f2937;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-start justify-center p-4 sm:p-8">
    <div
      id="app"
      class="w-full max-w-sm bg-gray-900 rounded-3xl shadow-2xl overflow-hidden mt-10 p-6 sm:p-8"
    >
      <!-- App content will be rendered here -->
    </div>

    <script type="module">
      // --- Local Storage Key ---
      const LOCAL_HISTORY_KEY = 'face_reading_history';

      // --- Global App Variables (No Firebase) ---
      // Generate a simple, non-persistent user ID
      let userId = 'Local-' + Math.random().toString(36).substring(2, 9); 
      
      // --- Application Data: Facial Features (Unchanged) ---
      const allFaceFeatures = 
      [
  // --- EXPANDED CATEGORIES ---

  {
    name: "Nostril Shape (Financial Perspective)",
    key: "nostril_shape",
    description: "Select the shape and size of the nostrils (Financial Risk & Spending Habits).",
    features: [
      {
        name: "Large/Flared Nostrils (Generous Spender)",
        trait:
          "Indicates a generous, open nature, often comfortable with taking financial risks and spending freely on self or others. High potential for earning but also for spending.",
        image: "https://placehold.co/300x300/ff7f50/ffffff?text=Flared+Nostrils",
      },
      {
        name: "Small/Hidden Nostrils (Careful Saver)",
        trait:
          "Associated with cautious financial management, a tendency to be a meticulous saver, and a practical approach to spending. They often build wealth steadily.",
        image: "https://placehold.co/300x300/4682b4/ffffff?text=Hidden+Nostrils",
      },
      {
        name: "Round/Symmetrical Nostrils (Balanced Finance)",
        trait:
          "Suggests a balanced approach to money, capable of both saving and sensible spending. Values stability and avoids unnecessary financial drama.",
        image: "https://placehold.co/300x300/3cb371/ffffff?text=Round+Nostrils",
      },
      {
        name: "Asymmetrical Nostrils (Unpredictable Finance)",
        trait:
          "Indicates a fluctuating or somewhat chaotic financial life. They may experience periods of great wealth followed by instability; requires self-discipline.",
        image: "https://placehold.co/300x300/ff0000/ffffff?text=Asym+Nostrils",
      },
    ],
  },
  {
    name: "Eye Shape (Emotional Outlook & Intelligence)",
    key: "eye_shape",
    description: "Select the shape of the eyes (Emotional Outlook & Intelligence).",
    features: [
      {
        name: "Almond Shaped (Exotic/Clever)",
        trait: "Indicates a person who is clever, slightly secretive, and highly observant. They are emotionally controlled and often have a magnetic, mysterious appeal.",
        image: "https://placehold.co/300x300/9333ea/ffffff?text=Almond+Eyes"
      },
      {
        name: "Round/Large Eyes (Innocent/Open)",
        trait: "Suggests a person who is emotional, expressive, and wears their heart on their sleeve. They are often perceived as innocent, approachable, and romantic.",
        image: "https://placehold.co/300x300/ec4899/ffffff?text=Round+Eyes"
      },
      {
        name: "Narrow/Hooded Eyes (Analytical)",
        trait: "Associated with a sharp, analytical mind. This person observes details others miss and may be guarded with their true feelings until trust is established.",
        image: "https://placehold.co/300x300/6366f1/ffffff?text=Hooded+Eyes"
      },
      {
        name: "Upturned Eyes (Ambitious/Driven)",
        trait: "Indicates an ambitious, powerful, and highly driven personality. They seek success and respect, often taking a competitive stance in their career and life.",
        image: "https://placehold.co/300x300/f59e0b/ffffff?text=Upturned+Eyes",
      },
      {
        name: "Downturned Eyes (Empathetic/Sensitive)",
        trait: "Suggests a deeply empathetic, kind, and nurturing nature. They are sensitive to the feelings of others and may carry emotional weight, sometimes leading to perceived sadness.",
        image: "https://placehold.co/300x300/fb7185/ffffff?text=Downturned+Eyes",
      },
    ]
  },
  {
    name: "Eye Spacing (Perspective & Attention to Detail)",
    key: "eye_spacing",
    description:
      "Select the distance between the inner corners of the eyes (Perspective & Attention to Detail).",
    features: [
      {
        name: "Wide-Set Eyes (Big Picture)",
        trait:
          "Indicates a person who thrives on a broad perspective, flexibility, and adaptability. They are highly tolerant, struggle with restrictive details, and see the 'big picture'.",
        image: "https://placehold.co/300x300/da70d6/ffffff?text=Wide+Set+Eyes",
      },
      {
        name: "Close-Set Eyes (Detail Focused)",
        trait:
          "Suggests a focused, intense, and highly detail-oriented mindset. They excel at specialized tasks, prefer order, and can become easily stressed by chaos or disruption.",
        image: "https://placehold.co/300x300/ffd700/ffffff?text=Close+Set+Eyes",
      },
      {
        name: "Average Spacing (Measured)",
        trait:
          "Represents a balanced and measured perspective. They can transition easily between focusing on details and understanding the overall scope of a situation.",
        image: "https://placehold.co/300x300/20b2aa/ffffff?text=Average+Spacing",
      },
    ],
  },
  {
    name: "Eyebrow Curve (Decision Making & Attitude)",
    key: "eyebrow_curve",
    description: "Select the arch of the eyebrows (Decision Making & Attitude).",
    features: [
      {
        name: "High Arch (Dramatic/Artistic)",
        trait: "Indicates a flair for drama and aesthetics. They may be perfectionists with high standards, preferring quality over quantity in all aspects of life.",
        image: "https://placehold.co/300x300/db2777/ffffff?text=High+Arch"
      },
      {
        name: "Straight/Flat (Logical/Linear)",
        trait: "Suggests a very logical, practical, and linear thinker. They approach problems directly using facts rather than emotion and value efficiency.",
        image: "https://placehold.co/300x300/4b5563/ffffff?text=Straight+Brows"
      },
      {
        name: "Curved/Rounded (People-Oriented)",
        trait: "Associated with a friendly, diplomatic nature. They value harmony in relationships and often make decisions based on how it affects the group.",
        image: "https://placehold.co/300x300/10b981/ffffff?text=Curved+Brows"
      },
      {
        name: "Dipping/Angled (Intensity/Focus)",
        trait: "Indicates a person who can focus intensely and has high expectations, leading to rapid advancement. They may come across as intense or slightly demanding.",
        image: "https://placehold.co/300x300/34d399/ffffff?text=Dipping+Brows",
      },
    ]
  },
  {
    name: "Dimples/Facial Marks (Emotional Expression & Fortune)",
    key: "marks",
    description:
      "Select the presence of dimples or major facial lines (Emotional Expression & Fortune).",
    features: [
      {
        name: "Cheek Dimples (Friendly/Charming)",
        trait:
          "Symbolizes inherent optimism, a joyful personality, and strong social magnetism. Often brings good fortune in social and public spheres; excellent rapport builder.",
        image: "https://placehold.co/300x300/ff69b4/ffffff?text=Cheek+Dimples",
      },
      {
        name: "Pronounced Laugh Lines (Warm & Experienced)",
        trait:
          "Indicates a person who is expressive, frequently happy, and warm. These lines suggest an experienced life, a good sense of humor, and high emotional resilience.",
        image: "https://placehold.co/300x300/4b0082/ffffff?text=Laugh+Lines",
      },
      {
        name: "No Prominent Marks (Controlled Expression)",
        trait:
          "Suggests a more reserved and controlled emotional expression. This person often approaches life with caution, values a neutral appearance, and maintains privacy.",
        image: "https://placehold.co/300x300/a9a9a9/ffffff?text=No+Marks",
      },
      {
        name: "Vertical Line between Brows (Stress/Discipline)",
        trait:
          "Often called the 'Suspicion Line.' Indicates a disciplined, focused individual, but also suggests high mental pressure, frequent stress, or deep introspection.",
        image: "https://placehold.co/300x300/06b6d4/ffffff?text=Vertical+Worry+Line",
      },
    ],
  },
  {
    name: "Earlobe Size (Longevity & Character Foundation)",
    key: "earlobes",
    description:
      "Select the relative size and attachment of the earlobes (Longevity & Character Foundation).",
    features: [
      {
        name: "Large/Long Earlobe (Wisdom/Fortune)",
        trait:
          "Often associated with great wisdom, excellent health, and long-term financial fortune. Suggests a kind, grounded, and generous personality foundation.",
        image: "https://placehold.co/300x300/ff8c00/ffffff?text=Large+Earlobe",
      },
      {
        name: "Small/Attached Earlobe (Practicality)",
        trait:
          "Indicates a highly practical, down-to-earth, and self-reliant individual. They value concrete results and tend to be frugal and focused on immediate goals.",
        image: "https://placehold.co/300x300/6a5acd/ffffff?text=Attached+Earlobe",
      },
      {
        name: "Medium/Free Earlobe (Balanced Life)",
        trait:
          "Suggests a balanced character, capable of adapting to change while maintaining stability. They possess good common sense and a moderate approach to risk.",
        image: "https://placehold.co/300x300/7fffd4/ffffff?text=Free+Earlobe",
      },
    ],
  },
  {
    name: "Jawline Definition (Willpower & Determination)",
    key: "jawline",
    description: "Select the shape and strength of the jawline (Willpower & Determination).",
    features: [
      {
        name: "Strong/Square Jaw (Determined)",
        trait: "A sign of immense physical stamina, willpower, and leadership capability. These individuals do not give up easily and can be stubborn in their pursuits.",
        image: "https://placehold.co/300x300/7c2d12/ffffff?text=Strong+Jaw"
      },
      {
        name: "Narrow/Pointed Jaw (Intellectual)",
        trait: "Suggests a person who relies more on mental agility than physical brute force. They are often flexible, adaptable, and intuitive but may lack raw stamina.",
        image: "https://placehold.co/300x300/0f766e/ffffff?text=Narrow+Jaw"
      },
      {
        name: "Round/Soft Jaw (Cooperative)",
        trait: "Indicates a lover of peace, comfort, and good food. They are excellent team players who prefer cooperation over conflict and value a comfortable lifestyle.",
        image: "https://placehold.co/300x300/be185d/ffffff?text=Round+Jaw"
      },
      {
        name: "Receding Jaw (Flexibility/Dependence)",
        trait: "Suggests a highly flexible and agreeable nature. They may avoid confrontation and sometimes require external motivation or support to maintain long-term goals.",
        image: "https://placehold.co/300x300/404040/ffffff?text=Receding+Jaw",
      },
    ]
  },
  {
    name: "Mouth Size (Social Energy & Appetite)",
    key: "mouth_size",
    description: "Select the relative size of the mouth (Social Energy & Appetite).",
    features: [
      {
        name: "Large Mouth (Extroverted/Ambitious)",
        trait: "Indicates a high appetite for life, social interaction, and success. They are often charismatic, loud, and persuasive speakers who influence others easily.",
        image: "https://placehold.co/300x300/c2410c/ffffff?text=Large+Mouth"
      },
      {
        name: "Small Mouth (Introverted/Select)",
        trait: "Suggests a person who is more private and selective. They may be 'picky' eaters or choosy with friends, keeping a small but loyal inner circle.",
        image: "https://placehold.co/300x300/0369a1/ffffff?text=Small+Mouth"
      },
      {
        name: "Medium Mouth (Balanced)",
        trait: "Represents a healthy balance between social output and private reflection. They can navigate social situations well without needing to be the center of attention.",
        image: "https://placehold.co/300x300/4d7c0f/ffffff?text=Medium+Mouth"
      }
    ]
  },
  {
    name: "Neck Length/Thickness (Resilience & Personal Power)",
    key: "neck",
    description:
      "Select the prominence and length of the neck (Resilience & Personal Power).",
    features: [
      {
        name: "Thick/Short Neck (Strong Will)",
        trait:
          "Denotes high energy, physical resilience, and a strong, unyielding will. They are highly determined, practical, and often have great stamina for long projects.",
        image: "https://placehold.co/300x300/800000/ffffff?text=Thick+Neck",
      },
      {
        name: "Long/Slender Neck (Refined/Idealist)",
        trait:
          "Associated with grace, refinement, idealism, and an intellectual focus. They tend to be more sensitive to environment and appreciate aesthetic quality.",
        image: "https://placehold.co/300x300/008080/ffffff?text=Slender+Neck",
      },
      {
        name: "Average Neck (Stable & Reliable)",
        trait:
          "Suggests stability, reliability, and a steady temperament. They are dependable, handle stress well, and maintain a consistent pace in life.",
        image: "https://placehold.co/300x300/b0c4de/ffffff?text=Average+Neck",
      },
    ],
  },
  {
    name: "Teeth Alignment (Verbal Stamina & Openness)",
    key: "teeth",
    description:
      "Select the general condition and spacing of the front teeth (Verbal Stamina & Openness).",
    features: [
      {
        name: "Straight/Even Teeth (Integrity)",
        trait:
          "Indicates high integrity, reliability, and a straightforward approach to communication. They are perceived as trustworthy and speak with confidence.",
        image: "https://placehold.co/300x300/66cdaa/ffffff?text=Straight+Teeth",
      },
      {
        name: "Gapped Teeth (Openness/Generosity)",
        trait:
          "Associated with high communicative openness, generosity, and an abundance of life energy. They are often talkative, spontaneous, and embrace change easily.",
        image: "https://placehold.co/300x300/dda0dd/ffffff?text=Gapped+Teeth",
      },
      {
        name: "Overlapping/Crowded Teeth (Reserved)",
        trait:
          "Suggests a more reserved or cautious nature, particularly in sharing personal information. They are often methodical but may struggle to express opinions directly.",
        image: "https://placehold.co/300x300/ba55d3/ffffff?text=Crowded+Teeth",
      },
      {
        name: "Large/Prominent Front Teeth (Verbal Impact)",
        trait:
          "Indicates a person whose words carry significant weight and influence. They are naturally expressive and possess a high degree of verbal energy and confidence.",
        image: "https://placehold.co/300x300/8b5cf6/ffffff?text=Prominent+Teeth",
      },
    ],
  },
  {
    name: "Hairline Shape (Maturity & Thinking Style)",
    key: "hairline",
    description:
      "Select the prominence and length of the neck (Resilience & Personal Power).",
    features: [
      {
        name: "Straight/Receding Hairline (Practical Maturity)",
        trait:
          "Associated with highly practical, systematic thinkers who gain wisdom early. They value structure and order; can indicate a focus on material goals over purely creative ones.",
        image: "https://placehold.co/300x300/4a4e69/ffffff?text=Straight+Hairline",
      },
      {
        name: "Rounded/Soft Hairline (Gentle Creativity)",
        trait:
          "Suggests a gentle, sensitive, and artistic nature. They often have high emotional intelligence and enjoy imaginative or nurturing pursuits. Retains a youthful outlook.",
        image: "https://placehold.co/300x300/98c1d9/ffffff?text=Rounded+Hairline",
      },
      {
        name: "Widow's Peak (Dramatic/Willful)",
        trait:
          "Indicates a strong, determined, and sometimes dramatic personality. They are highly driven by personal ambition and can be quite persuasive or strong-willed.",
        image: "https://placehold.co/300x300/ee6c4d/ffffff?text=Widows+Peak",
      },
      {
        name: "M-Shaped Hairline (Artistic/Creative)",
        trait:
          "Suggests a highly intelligent, creative, and analytical mind. They are often imaginative and excel in fields that require strategic or artistic thinking.",
        image: "https://placehold.co/300x300/ff9800/ffffff?text=M-Shaped+Hairline",
      },
    ],
  },
  {
    name: "Skin Texture (Energy & Sensitivity)",
    key: "skin",
    description:
      "Select the general appearance of the skin (Energy & Sensitivity).",
    features: [
      {
        name: "Smooth/Clear Skin (Inner Harmony)",
        trait:
          "Suggests a balanced, calm internal state, good health, and an ability to flow easily through life's challenges. Represents a clear and consistent energy.",
        image: "https://placehold.co/300x300/fec89a/ffffff?text=Smooth+Skin",
      },
      {
        name: "Coarse/Rugged Skin (Resilience & Strength)",
        trait:
          "Indicates a hardworking, resilient, and enduring nature. They are often tough, practical, and highly capable of handling physical demands and external pressure.",
        image: "https://placehold.co/300x300/a52a2a/ffffff?text=Rugged+Skin",
      },
      {
        name: "Rosy/Flushed Skin (Emotional Sensitivity)",
        trait:
          "Associated with high emotional responsiveness, warmth, and an expressive nature. They wear their feelings openly, but may also be prone to stress or excitement.",
        image: "https://placehold.co/300x300/ff7f7f/ffffff?text=Rosy+Skin",
      },
      {
        name: "Oily/Shiny Skin (Active Metabolism/Emotion)",
        trait:
          "Suggests an active metabolism and high emotional responsiveness. May indicate a person who is energetic and passionate, sometimes leading to emotional overdrive.",
        image: "https://placehold.co/300x300/22c55e/ffffff?text=Shiny+Skin",
      },
    ],
  },
  {
    name: "Forehead Lines (Life Experience & Intellect)",
    key: "forehead_lines",
    description:
      "Select the dominant pattern of horizontal lines (Life Experience & Intellect).",
    features: [
      {
        name: "Three Parallel Lines (The 'Ladder' of Success)",
        trait:
          "Highly auspicious, suggesting intelligence, honor, and a steady climb to success. Indicates a disciplined and thoughtful approach to life and career.",
        image: "https://placehold.co/300x300/3c096c/ffffff?text=Three+Lines",
      },
      {
        name: "Wavy/Broken Lines (Restless Mind)",
        trait:
          "Suggests a restless, analytical mind that often jumps between ideas. This person may have experienced many life changes or struggles with consistent focus.",
        image: "https://placehold.co/300x300/7b2cbf/ffffff?text=Wavy+Lines",
      },
      {
        name: "Few/No Lines (Calmness/Youth)",
        trait:
          "Indicates a calm, perhaps youthful, and uncomplicated mental state. They tend to take things in stride and avoid excessive worry or deep mental turmoil.",
        image: "https://placehold.co/300x300/9d4edd/ffffff?text=Few+Lines",
      },
      {
        name: "Single Deep Line (Stubbornness/Focus)",
        trait:
          "A very pronounced single line suggests intense focus and great stubbornness or determination in one's chosen path. Can indicate a long struggle leading to success.",
        image: "https://placehold.co/300x300/d946ef/ffffff?text=Single+Deep+Line",
      },
    ],
  },
  {
    name: "Space Between Eyebrows (Mental Clarity & Fortune)",
    key: "yintang",
    description:
      "Select the space/clearness of the area between the eyebrows (Mental Clarity & Fortune).",
    features: [
      {
        name: "Wide and Clear Space (Open Mind/Luck)",
        trait:
          "Signifies an open-minded, optimistic, and highly intelligent nature. This person is thought to attract good fortune, maintain mental clarity, and handle stress effectively.",
        image: "https://placehold.co/300x300/6d28d9/ffffff?text=Wide+Clear+Space",
      },
      {
        name: "Narrow/Crowded Space (Intense Focus)",
        trait:
          "Indicates deep intensity, high focus, and a tendency toward over-analysis or worry. They are meticulous and dedicated but can be easily stressed or mentally blocked.",
        image: "https://placehold.co/300x300/a855f7/ffffff?text=Narrow+Space",
      },
      {
        name: "Lines/Creases Present (Worry/Activity)",
        trait:
          "Suggests frequent or intense mental activity, constant worry, or deep introspection. The person is highly expressive, often furrowing their brow in concentration or thought.",
        image: "https://placehold.co/300x300/c084fc/ffffff?text=Creased+Space",
      },
    ],
  },
  {
    name: "Wealth & Financial Fortune (Collection of Features)",
    key: "wealth",
    description:
      "Attributes related to financial stability, earning potential, and spending habits (Fortune & Career).",
    features: [
      {
        name: "Large Fleshy Nose Tip (The Wealthy Bulb)",
        trait:
          "The best sign of wealth accumulation and generosity. Suggests high earning potential and an ability to hold onto money; often successful later in life.",
        image: "https://placehold.co/300x300/059669/ffffff?text=Fleshy+Nose+Tip",
      },
      {
        name: "Full and Plump Chin (Security & Land)",
        trait:
          "Indicates longevity and security in later years. Associated with having real estate, reliable family support, and a stable financial foundation.",
        image: "https://placehold.co/300x300/047857/ffffff?text=Plump+Chin",
      },
      {
        name: "High and Full Cheekbones (Social Power)",
        trait:
          "Signifies a person who is highly influential, driven, and capable of managing large projects or teams, leading to high-status income.",
        image: "https://placehold.co/300x300/065f46/ffffff?text=Full+Cheekbones",
      },
      {
        name: "High Nasal Bridge (Ambition/Reach)",
        trait:
          "A strong, high bridge of the nose suggests a person with high ambition and a drive to reach important social and professional positions. Excellent career luck.",
        image: "https://placehold.co/300x300/15803d/ffffff?text=High+Nasal+Bridge",
      },
    ],
  },
  {
    name: "Love & Relationship Harmony (Collection of Features)",
    key: "love",
    description:
      "Attributes related to partnership quality, romantic fortune, and marital happiness (Harmony & Sensitivity).",
    features: [
      {
        name: "Full and Symmetrical Lips (Emotional Generosity)",
        trait:
          "The strongest sign of a nurturing, loving, and emotionally generous partner. They prioritize family and relationships, offering warmth and support.",
        image: "https://placehold.co/300x300/f43f5e/ffffff?text=Symmetrical+Full+Lips",
      },
      {
        name: "Clear, Smooth Skin around Eyes (Spouse Palace)",
        trait:
          "The area just past the corner of the eyes (Spouse Palace) being smooth and clear indicates a stable, happy, and loyal relationship path.",
        image: "https://placehold.co/300x300/e11d48/ffffff?text=Clear+Eye+Area",
      },
      {
        name: "Round Chin (Sociable/Harmonious)",
        trait:
          "Associated with a kind, harmonious, and agreeable nature. They seek peace in relationships and are excellent at compromising and listening.",
        image: "https://placehold.co/300x300/be123c/ffffff?text=Round+Chin+Love",
      },
      {
        name: "Clear, Defined Philtrum (Fertility/Desire for Family)",
        trait:
          "A well-defined Philtrum (the groove above the upper lip) is strongly linked to vitality and a happy, fruitful family life with strong, healthy children.",
        image: "https://placehold.co/300x300/9d174d/ffffff?text=Defined+Philtrum",
      },
    ],
  },
  {
    name: "Warning Signs: Deceit/Infidelity (Collection of Features)",
    key: "deceit",
    description:
      "Subtle attributes associated with secrecy, lack of forthrightness, and potential for emotional or financial cheating.",
    features: [
      {
        name: "Thin Lips (Reserved/Self-Serving)",
        trait:
          "While often independent, when combined with other traits, thin lips can suggest emotional reservation and a tendency to prioritize self-interest over the partner's needs.",
        image: "https://placehold.co/300x300/94a3b8/ffffff?text=Thin+Lips+Warning",
      },
      {
        name: "Small, Shifty Eyes (Evasive/Secretive)",
        trait:
          "Suggests a person who is secretive, cautious, and avoids direct confrontation or eye contact. May indicate a lack of transparency in personal or financial matters.",
        image: "https://placehold.co/300x300/475569/ffffff?text=Shifty+Eyes",
      },
      {
        name: "Mouth That Turns Down (Pessimism/Discontent)",
        trait:
          "Indicates chronic dissatisfaction or pessimism. This discontent can lead the person to seek fulfillment or excitement outside of an existing commitment (either romantic or financial).",
        image: "https://placehold.co/300x300/1e293b/ffffff?text=Mouth+Turned+Down",
      },
      {
        name: "Narrow/Deep Set Eyes (Guarded/Suspicious)",
        trait:
          "Suggests a person who is inherently guarded and skeptical of others' motives. They are difficult to get close to and are highly reserved with personal feelings and facts.",
        image: "https://placehold.co/300x300/334155/ffffff?text=Deep+Set+Eyes+Warning",
      },
    ],
  },
  {
    name: "Communication & Voice (Expressive Style)",
    key: "communication",
    description:
      "Attributes related to how the person expresses themselves verbally and socially (Clarity & Influence).",
    features: [
      {
        name: "Long/Deep Philtrum (Fertility & Vitality)",
        trait:
          "A clear, deep, and well-defined philtrum indicates excellent vitality, strong health, and clear, influential communication skills. Suggests a strong desire for children.",
        image: "https://placehold.co/300x300/65a30d/ffffff?text=Deep+Philtrum",
      },
      {
        name: "Thin/Shallow Philtrum (Lower Stamina)",
        trait:
          "Associated with lower physical and verbal stamina. This person may speak softly or prefer written communication over extended public speaking.",
        image: "https://placehold.co/300x300/a3e635/ffffff?text=Shallow+Philtrum",
      },
      {
        name: "Mouth that Moves A Lot (Expressive)",
        trait:
          "Suggests a person who is highly talkative, expressive, and uses their mouth to emphasize points. They are often dynamic communicators but can be prone to gossip.",
        image: "https://placehold.co/300x300/d9f99d/ffffff?text=Active+Mouth",
      },
      {
        name: "Clear Vertical Line Below Nose (Directness/Honesty)",
        trait:
          "A distinct vertical line from the nose to the lip (part of the Philtrum) indicates honesty, integrity, and directness in speech. They are reliable communicators.",
        image: "https://placehold.co/300x300/16a34a/ffffff?text=Clear+Philtrum+Line",
      },
    ],
  },
  {
    name: "Health & Life Force (Stamina & Life Path)",
    key: "vitality",
    description:
      "Attributes indicating the person's physical energy, resilience, and general health (Stamina & Life Path).",
    features: [
      {
        name: "Fleshy/Full Cheeks (Strong Reserves)",
        trait:
          "Indicates a person with strong internal reserves of energy (Qi), good health, and an ability to weather life's stresses. They usually have a long and stable life path.",
        image: "https://placehold.co/300x300/eab308/ffffff?text=Fleshy+Cheeks",
      },
      {
        name: "Defined, Long Chin (Long Life Endurance)",
        trait:
          "A long, well-defined chin is a classic sign of strong endurance, good health into old age, and an ability to persist through challenges (long-term stamina).",
        image: "https://placehold.co/300x300/ca8a04/ffffff?text=Long+Chin",
      },
      {
        name: "Sunken Eye Area (Lower Energy)",
        trait:
          "Suggests that the person may be prone to fatigue, stress, or requires more rest. May indicate a need to conserve energy or a lower emotional threshold.",
        image: "https://placehold.co/300x300/422006/ffffff?text=Sunken+Eyes",
      },
      {
        name: "Clear 'Life' Line from Nose (Longevity/Groundedness)",
        trait:
          "A clear, long line running from the side of the nose toward the corner of the mouth (Nasolabial Fold) is a strong sign of health, longevity, and groundedness.",
        image: "https://placehold.co/300x300/d97706/ffffff?text=Clear+Life+Line",
      },
    ],
  },
  {
    name: "Temperament & Reaction (Patience & Mood)",
    key: "temperament",
    description:
      "Attributes indicating the person's inherent emotional reactivity and general disposition (Patience & Mood).",
    features: [
      {
        name: "Thick/Coarse Eyebrows (Strong Temper)",
        trait:
          "Associated with a strong, passionate, and sometimes impatient temperament. They are highly energetic, decisive, but can be quick to anger or frustration.",
        image: "https://placehold.co/300x300/dc2626/ffffff?text=Thick+Brows",
      },
      {
        name: "Light/Sparse Eyebrows (Gentle Spirit)",
        trait:
          "Indicates a gentle, sensitive, and yielding personality. They are often quiet, reflective, and avoid conflict, preferring harmony and calm.",
        image: "https://placehold.co/300x300/f87171/ffffff?text=Sparse+Brows",
      },
      {
        name: "Prominent Brow Bone (Assertive/Logical)",
        trait:
          "Suggests a person who relies heavily on intellect and logic. They are assertive in their opinions and may struggle with accepting purely emotional arguments.",
        image: "https://placehold.co/300x300/fee2e2/ffffff?text=Prominent+Brow",
      },
      {
        name: "Deep Vertical Lines Between Brows (Frustration/Pressure)",
        trait:
          "Two deep vertical lines (known as the 'Suspension Bridge') indicate high mental pressure, a tendency to internalize frustration, and intense concentration.",
        image: "https://placehold.co/300x300/b91c1c/ffffff?text=Deep+Frown+Lines",
      },
    ],
  },
  {
    "name": "Reputation & Social Status (Public Image & Legacy)",
    "key": "reputation",
    "description": "Attributes related to public recognition, honor, and how the person is viewed by society (Public Image & Legacy).",
    "features": [
      {
        "name": "Fullness Above Eyebrows (Career/Status)",
        "trait": "A smooth, full area just above the eyebrows (the 'Official Seal') suggests a strong career trajectory, high honor, and an ability to achieve a respected public status.",
        "image": "https://placehold.co/300x300/fcd34d/ffffff?text=Full+Brow+Area"
      },
      {
        "name": "Prominent, Clear Forehead (Good Legacy)",
        "trait": "A wide, clear, and high forehead indicates a good relationship with superiors and authorities, leading to promotion and a respected legacy in their field.",
        "image": "https://placehold.co/300x300/fbbf24/ffffff?text=Clear+Forehead"
      },
      {
        "name": "Strong Back of Head (Support/Foundation)",
        "trait": "While not on the front face, a strong, well-formed back of the head (occiput) suggests powerful foundational support from family or mentors, which assists public status.",
        "image": "https://placehold.co/300x300/f59e0b/ffffff?text=Strong+Occiput"
      },
      {
        "name": "Well-Defined Nose Tip (Integrity/Trustworthiness)",
        "trait": "A clear, rounded nose tip with defined cartilage suggests strong personal integrity and consistency, which builds long-term public trust and reputation.",
        "image": "https://placehold.co/300x300/eab308/ffffff?text=Defined+Nose+Tip",
      }
    ]
  },
  {
    "name": "Parental & Family Relations (Foundation & Ancestry)",
    "key": "family",
    "description": "Attributes indicating the quality of the person's relationship with their parents and family support structure (Foundation & Ancestry).",
    "features": [
      {
        "name": "Fullness at Hairline Corners (Sun & Moon)",
        "trait": "The left (Sun) and right (Moon) corners of the forehead represent parents. Fullness and clarity here indicate a loving, supportive relationship with both parents.",
        "image": "https://placehold.co/300x300/10b981/ffffff?text=Full+Hairline+Corners"
      },
      {
        "name": "Clear, Full Pouch Below Eyes (Children)",
        "trait": "The area directly under the eye is tied to one's children and future. A clear, slightly full pouch suggests healthy children and a strong, happy family life.",
        "image": "https://placehold.co/300x300/059669/ffffff?text=Clear+Eye+Pouch"
      },
      {
        "name": "Eyebrows That Meet (Strong Family Focus)",
        "trait": "When the inner ends of the eyebrows touch or are very close, it indicates an intense focus on family, often leading them to place family needs above their own.",
        "image": "https://placehold.co/300x300/04785e/ffffff?text=Touching+Brows"
      },
      {
        "name": "Fullness Under Outer Corner of the Eye (Support from Friends)",
        "trait": "This area relates to the extended network. Fullness here suggests strong support from close friends and a wide, chosen family circle who provide assistance in life.",
        "image": "https://placehold.co/300x300/0f766e/ffffff?text=Friend+Support+Area",
      }
    ]
  },
  {
    "name": "Pace of Life & Decision Making (Tempo & Action)",
    "key": "pace",
    "description": "Attributes related to the person's natural speed, rhythm, and method of processing information (Tempo & Action).",
    "features": [
      {
        "name": "Large Nostrils (Fast Pace/Spontaneous)",
        "trait": "Indicates a person who acts quickly, often spontaneously, and thrives on rapid changes. They dislike slow processes and are naturally high-energy.",
        "image": "https://placehold.co/300x300/f97316/ffffff?text=Large+Nostrils+Pace"
      },
      {
        "name": "Small Mouth (Reserved/Methodical Pace)",
        "trait": "Suggests a methodical, slow, and reserved approach to life. They prefer to observe and plan extensively before taking action, ensuring every step is secure.",
        "image": "https://placehold.co/300x300/fb923c/ffffff?text=Small+Mouth+Pace"
      },
      {
        "name": "Horizontal Forehead Line (Steady Progress)",
        "trait": "A single, clear horizontal line across the forehead indicates a steady, determined, and continuous rhythm of progress throughout life.",
        "image": "https://placehold.co/300x300/ea580c/ffffff?text=Steady+Forehead+Line"
      },
      {
        "name": "Short Upper Lip (Impatience/Directness)",
        "trait": "A short space between the nose and upper lip suggests a lack of patience, leading to quick reactions and a tendency to speak or act without much delay.",
        "image": "https://placehold.co/300x300/c2410c/ffffff?text=Short+Upper+Lip+Pace",
      }
    ]
  },

  // --- NEW CATEGORIES ADDED ---

  {
    name: "Forehead Shape (Intellectual Capacity & Early Life)",
    key: "forehead_shape",
    description: "The shape and slope of the forehead, relating to intellect and the years 15-30.",
    features: [
      {
        name: "High and Rounded (Visionary/Idealist)",
        trait:
          "Suggests a person with great vision, high intellect, and strong conceptual thinking. They are often idealists who succeed in artistic or academic fields.",
        image: "https://placehold.co/300x300/8b5cf6/ffffff?text=High+Rounded+Forehead",
      },
      {
        name: "Low and Narrow (Practical/Worker)",
        trait:
          "Indicates a practical, hands-on learner who excels in technical or administrative tasks. They thrive on concrete facts and may start their career early.",
        image: "https://placehold.co/300x300/a78bfa/ffffff?text=Low+Narrow+Forehead",
      },
      {
        name: "Sloping/Receding (Quick Thinker/Action-Oriented)",
        trait:
          "Associated with people who think quickly on their feet and prefer action over contemplation. They may make impulsive decisions but are highly entrepreneurial.",
        image: "https://placehold.co/300x300/c4b5fd/ffffff?text=Sloping+Forehead",
      },
      {
        name: "Square/Broad (Structured/Authority)",
        trait:
          "Suggests an organized, highly structured mind. They are natural leaders, managers, and excel in positions of authority and planning.",
        image: "https://placehold.co/300x300/ddd6fe/ffffff?text=Square+Forehead",
      },
    ],
  },
  {
    name: "Cheekbone Prominence (Authority & Social Drive)",
    key: "cheekbones",
    description: "The height and definition of the cheekbones (Influence & Ambition).",
    features: [
      {
        name: "High and Wide (Dominant/Leader)",
        trait:
          "A person who naturally commands attention and authority. They are driven, ambitious, and excel in leadership roles where influence is required. Can be headstrong.",
        image: "https://placehold.co/300x300/f59e0b/ffffff?text=High+Wide+Cheekbones",
      },
      {
        name: "Low/Flat (Cooperative/Supportive)",
        trait:
          "Indicates a highly supportive and non-confrontational personality. They are excellent team members who thrive in roles providing assistance or technical skill.",
        image: "https://placehold.co/300x300/fcd34d/ffffff?text=Low+Flat+Cheekbones",
      },
      {
        name: "Fleshy/Full (Wealthy Power)",
        trait:
          "Suggests a comfortable life with steady income and influence that grows over time. Their power is usually based on financial stability and social connections.",
        image: "https://placehold.co/300x300/fde047/ffffff?text=Fleshy+Cheekbones",
      },
    ],
  },
  {
    name: "Lip Thickness (Emotional Generosity & Nurturing)",
    key: "lip_thickness",
    description: "The relative thickness of the upper and lower lips (Nurturing Ability & Communication).",
    features: [
      {
        name: "Full Upper and Lower Lips (Nurturing/Emotional)",
        trait:
          "A classic sign of high emotional intelligence, warmth, and a deep desire to nurture others (family, friends, or pets). They are generous with their feelings.",
        image: "https://placehold.co/300x300/ef4444/ffffff?text=Full+Lips",
      },
      {
        name: "Thin Upper and Lower Lips (Independent/Reserved)",
        trait:
          "Indicates a strong sense of independence and self-reliance. They are often reserved with their emotions and may prefer to rely only on themselves.",
        image: "https://placehold.co/300x300/f87171/ffffff?text=Thin+Lips",
      },
      {
        name: "Full Lower Lip (Self-Pleasure/Materialism)",
        trait:
          "Suggests a focus on personal pleasure, comfort, and material enjoyment. They enjoy good food, luxury, and prioritize taking care of their own needs first.",
        image: "https://placehold.co/300x300/fca5a5/ffffff?text=Full+Lower+Lip",
      },
      {
        name: "Full Upper Lip (Giving/Verbal Nurturing)",
        trait:
          "Associated with being highly generous in speech and providing emotional support to others. They are excellent caregivers and counselors who use words to comfort.",
        image: "https://placehold.co/300x300/fee2e2/ffffff?text=Full+Upper+Lip",
      },
    ],
  },
  {
    name: "Nose Bridge Shape (Career Path & Ambition)",
    key: "nose_bridge",
    description: "The shape and height of the nose bridge (Ambition & Professional Life).",
    features: [
      {
        name: "Straight/High Bridge (Steady Career)",
        trait:
          "Indicates a steady, reliable career path marked by consistency and integrity. They rise steadily in their field and are respected by colleagues and superiors.",
        image: "https://placehold.co/300x300/4c1d95/ffffff?text=Straight+High+Bridge",
      },
      {
        name: "Concave/Scooped Bridge (Creative/Adaptable)",
        trait:
          "Suggests a more adaptable and creative personality. They may find success in flexible or artistic careers and are highly perceptive to emotional nuances.",
        image: "https://placehold.co/300x300/7c3aed/ffffff?text=Scooped+Bridge",
      },
      {
        name: "Aquiline/Bumpy Bridge (Willful/Fighter)",
        trait:
          "Associated with a powerful, competitive, and highly determined personality. They succeed by overcoming opposition and possess immense willpower and entrepreneurial drive.",
        image: "https://placehold.co/300x300/9333ea/ffffff?text=Aquiline+Bridge",
      },
      {
        name: "Flat/Broad Bridge (Team Player/Community)",
        trait:
          "Indicates a focus on community, family, and team success. They are highly cooperative and succeed best when working collaboratively rather than alone.",
        image: "https://placehold.co/300x300/a855f7/ffffff?text=Flat+Broad+Bridge",
      },
    ],
  },
  {
    name: "Chin Shape (Later Life & Security)",
    key: "chin_shape",
    description: "The overall form of the chin (Later Life, Endurance, and Family Security).",
    features: [
      {
        name: "Square/Broad Chin (Longevity/Stubborn)",
        trait:
          "A sign of a successful, stable later life and high physical endurance. They are often stubborn and require solid foundations, particularly regarding real estate.",
        image: "https://placehold.co/300x300/0891b2/ffffff?text=Square+Broad+Chin",
      },
      {
        name: "Pointed/Narrow Chin (Agile/Flexible)",
        trait:
          "Suggests an agile, intellectual, and adaptable nature. They may be more flexible in later life, relying on mental activity rather than rigid plans for security.",
        image: "https://placehold.co/300x300/22d3ee/ffffff?text=Pointed+Narrow+Chin",
      },
      {
        name: "Double Chin/Fullness (Comfort/Affluence)",
        trait:
          "In physiognomy, slight fullness here is highly favorable, suggesting a life of comfort, good fortune, and financial affluence in old age. A true sign of security.",
        image: "https://placehold.co/300x300/67e8f9/ffffff?text=Full+Chin",
      },
      {
        name: "Cleft Chin (Sociable/Charismatic)",
        trait:
          "Associated with a sociable, passionate, and charismatic personality. They attract attention and support, often leading to a rich and well-supported social life in their later years.",
        image: "https://placehold.co/300x300/a5f3fc/ffffff?text=Cleft+Chin",
      },
    ],
  },
]
      ;

      // --- State Management ---
      let state = {
        currentCategoryIndex: 0,
        currentFeatureIndex: 0,
        finalSelections: {},
        error: null,
        cardAnimation: null,
        isDragging: false,
        startX: 0,
        currentX: 0,
        swipeThreshold: 80,
        view: "selection", // 'selection', 'reading', 'history', 'historyDetail'
        history: [], // List of saved readings (loaded from localStorage)
        selectedHistoryItem: null, // Detailed reading object to view
        isSaving: false,
      };

      const appDiv = document.getElementById("app");
      let cardTimeout = null;

      // --- Global Function Access ---
      // Declare functions globally so the dynamically generated HTML (onclick) can find them.
      window.setState = setState;
      window.handleSkip = handleSkip;
      window.handleSelect = handleSelect;
      window.handleUndo = handleUndo;
      window.handleSkipAll = handleSkipAll;
      window.copyReadingToClipboard = copyReadingToClipboard;

      /**
       * Updates the state and triggers a re-render.
       * @param {object} newState - Partial state object to merge.
       */
      function setState(newState) {
        state = { ...state, ...newState };
        renderUI();
      }

      // --- Local Storage Logic (REPLACING Firestore) ---

      /** Loads history from localStorage. */
      function loadHistoryFromLocal() {
        try {
          const storedHistory = localStorage.getItem(LOCAL_HISTORY_KEY);
          if (storedHistory) {
            const history = JSON.parse(storedHistory);
            if (Array.isArray(history)) {
                 // Sort by date (newest first)
                history.sort((a, b) => new Date(b.date) - new Date(a.date));
                return history;
            }
          }
        } catch (e) {
          console.error("Error loading history from local storage:", e);
        }
        return [];
      }
      
      /** Saves the current state history array to localStorage. */
      function saveHistoryToLocal(newReading) {
        // Create the new history item structure
        const historyItem = {
            id: Date.now().toString(), // Use timestamp as ID
            ...newReading,
            // Create a summary for display
            summary: Object.keys(newReading.selections)
                .map((key) => newReading.selections[key].name)
                .join(", "),
            // Store the readable date string for display
            createdAt: new Date().toLocaleString(), 
        };
        
        // Prepend the new reading to the start of the current history array
        const updatedHistory = [historyItem, ...state.history];
        
        // Update state first, and turn off saving indicator
        setState({ history: updatedHistory, isSaving: false });

        try {
            // Save the updated list to local storage
            localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(updatedHistory));
            console.log("Reading saved locally.");
        } catch (e) {
            console.error("Error saving history to local storage:", e);
            setState({
                error: "Failed to save reading history locally. Local storage may be full.",
                isSaving: false
            });
        }
      }

      // --- App Initialization (REPLACING Firebase Init) ---
      
      /** Initializes the stand-alone app components and loads local data. */
      function initializeApp() {
        console.log("Initializing stand-alone app.");
        // Load history from local storage and update state
        const initialHistory = loadHistoryFromLocal();
        setState({ history: initialHistory, error: null });
        // Start rendering after state is set
        renderUI();
      }
      
      // --- Core Logic: Swiping & Button Actions (UNCHANGED logic structure) ---

      function handleSkip(fromSwipe = false) {
        if (state.view !== "selection") return;
        clearTimeout(cardTimeout);

        if (!fromSwipe) {
          setState({ cardAnimation: "exit-left", error: null });
        }

        cardTimeout = setTimeout(
          () => {
            const currentCategory = allFaceFeatures[state.currentCategoryIndex];

            let nextFeatureIndex = state.currentFeatureIndex + 1;

            if (nextFeatureIndex < currentCategory.features.length) {
              setState({
                currentFeatureIndex: nextFeatureIndex,
                cardAnimation: "card-enter",
              });
            } else {
              // Loop back to the first feature if all have been skipped for the current category
              setState({
                currentFeatureIndex: 0,
                error: `You must select one feature for ${currentCategory.name} or use "Skip All" to proceed.`,
                cardAnimation: "card-enter",
              });
            }
          },
          fromSwipe ? 10 : 300
        );
      }

      async function handleSelect(fromSwipe = false) {
        if (state.view !== "selection") return;
        const currentCategory = allFaceFeatures[state.currentCategoryIndex];
        const selectedFeature =
          currentCategory.features[state.currentFeatureIndex];

        clearTimeout(cardTimeout);

        if (!fromSwipe) {
          setState({ cardAnimation: "exit-right", error: null });
        }

        cardTimeout = setTimeout(
          () => {
            const newSelections = {
              ...state.finalSelections,
              [currentCategory.key]: selectedFeature,
            };

            const nextCategoryIndex = state.currentCategoryIndex + 1;

            if (nextCategoryIndex < allFaceFeatures.length) {
              // Move to next category
              setState({
                finalSelections: newSelections,
                currentCategoryIndex: nextCategoryIndex,
                currentFeatureIndex: 0,
                cardAnimation: "card-enter",
              });
            } else {
              // Last category selected, transition to reading screen and save
              completeReading(newSelections);
            }
          },
          fromSwipe ? 10 : 300
        );
      }

      function handleUndo() {
        if (state.view !== "selection") return;
        if (state.currentCategoryIndex > 0) {
          const prevCategory = allFaceFeatures[state.currentCategoryIndex - 1];

          const newSelections = { ...state.finalSelections };
          delete newSelections[prevCategory.key];

          setState({
            currentCategoryIndex: state.currentCategoryIndex - 1,
            currentFeatureIndex: 0,
            finalSelections: newSelections,
            error: null,
            cardAnimation: null,
          });
        }
      }

      function completeReading(finalSelections) {
        // Last category selected or skipped all, transition to reading screen and save
        setState({
          finalSelections: finalSelections,
          view: "reading",
          cardAnimation: null,
          isSaving: true, // Indicate that saving is in progress (briefly for local storage)
        });
        // Trigger local save immediately (replaces async Firestore call)
        const readingData = {
          selections: finalSelections,
          date: new Date().toISOString(), // Use ISO date for accurate sorting/display later
          userId: userId // Store the local ID
        };
        saveHistoryToLocal(readingData);
      }

      function handleSkipAll() {
        if (state.view !== "selection") return;

        // Start from the current index and automatically select the first feature for all remaining categories
        let newSelections = { ...state.finalSelections };

        for (
          let i = state.currentCategoryIndex;
          i < allFaceFeatures.length;
          i++
        ) {
          const category = allFaceFeatures[i];
          // Always pick the first feature as the default/skip selection
          const defaultFeature = category.features[0];

          newSelections[category.key] = {
            ...defaultFeature,
            name: `${defaultFeature.name} (Auto-Skipped)`,
          };
        }

        // Move to the final screen with the completed selections
        completeReading(newSelections);
      }
      
      // Copy text to clipboard function (unchanged)
      function copyReadingToClipboard(selections) {
        if (!selections) selections = state.finalSelections;
        
        let text = " Face Reading Analysis \n\n";
        
        Object.entries(selections).forEach(([key, feature]) => {
           const category = allFaceFeatures.find((c) => c.key === key);
           const categoryName = category ? category.name : key;
           text += ` ${categoryName}: ${feature.name}\n  "${feature.trait}"\n\n`;
        });
        
        text += `\nGenerated by Face Reader App`;
        
        // Fallback method using document.execCommand('copy')
        const textArea = document.createElement("textarea");
        textArea.value = text;
        // Move outside the screen to make it invisible
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
           document.execCommand('copy');
           // Replaced alert() with console log and message box logic (not explicitly implemented here, but respecting the rule)
           console.log("Reading copied to clipboard!"); 
        } catch (err) {
           console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
      }

      // --- Swipe Implementation (Unchanged) ---

      function getClientX(event) {
        if (event.touches) {
          return event.touches[0].clientX;
        }
        return event.clientX;
      }

      function startSwipe(event) {
        if (state.isDragging || state.error || state.view !== "selection") return;

        const card = document.getElementById("feature-card");
        if (!card) return;

        if (event.type === "mousedown") {
          event.preventDefault();
        }

        card.classList.add("is-dragging");

        state.isDragging = true;
        state.startX = getClientX(event);
        state.currentX = state.startX;
      }

      function moveSwipe(event) {
        if (!state.isDragging) return;

        const card = document.getElementById("feature-card");
        if (!card) return;

        const currentX = getClientX(event);
        const deltaX = currentX - state.startX;

        if (event.type === "touchmove") {
          const deltaY =
            event.touches[0].clientY - card.getBoundingClientRect().top;
          if (Math.abs(deltaX) > Math.abs(deltaY) * 0.5) {
            event.preventDefault();
          }
        }

        state.currentX = currentX;

        card.style.transform = `translateX(${deltaX}px) rotate(${
          deltaX / 30
        }deg)`;
        card.style.opacity =
          1 - Math.min(1, Math.abs(deltaX) / (card.clientWidth * 0.7));
      }

      function endSwipe() {
        if (!state.isDragging) return;
        state.isDragging = false;

        const card = document.getElementById("feature-card");
        if (!card) return;

        card.classList.remove("is-dragging");

        const deltaX = state.currentX - state.startX;

        if (deltaX > state.swipeThreshold) {
          // Swiped Right (Select) - Manual exit animation
          card.style.transform = `translateX(150%) rotate(10deg)`;
          card.style.opacity = 0;
          setTimeout(() => handleSelect(true), 300);
        } else if (deltaX < -state.swipeThreshold) {
          // Swiped Left (Skip) - Manual exit animation
          card.style.transform = `translateX(-150%) rotate(-10deg)`;
          card.style.opacity = 0;
          setTimeout(() => handleSkip(true), 300);
        } else {
          // Snap back to center
          card.style.transform = "translateX(0)";
          card.style.opacity = 1;
        }
      }

      function setupSwipeEvents() {
        const card = document.getElementById("feature-card");
        if (!card || state.currentCategoryIndex >= allFaceFeatures.length) return;

        // Clean up previous listeners to prevent duplicates
        document.removeEventListener("mousemove", moveSwipe);
        document.removeEventListener("mouseup", endSwipe);
        document.removeEventListener("touchmove", moveSwipe);
        document.removeEventListener("touchend", endSwipe);
        document.removeEventListener("touchcancel", endSwipe);

        // Mouse Events
        card.addEventListener("mousedown", startSwipe);
        document.addEventListener("mousemove", moveSwipe);
        document.addEventListener("mouseup", endSwipe);

        // Touch Events
        card.addEventListener("touchstart", startSwipe);
        document.addEventListener("touchmove", moveSwipe, { passive: false });
        document.addEventListener("touchend", endSwipe);
        document.addEventListener("touchcancel", endSwipe);
      }

      // --- Rendering Functions ---

      function renderHeader() {
        // Changed "User ID" to "Local ID"
        return `
            <div class="flex justify-between items-center text-white pb-4 mb-4 border-b border-gray-700">
                <h1 class="text-xl font-bold text-indigo-400">Face Reader</h1>
                <div class="flex space-x-2">
                    <button 
                        onclick="setState({view: 'selection', currentCategoryIndex: 0, currentFeatureIndex: 0, finalSelections: {}, error: null})"
                        class="p-2 rounded-full ${
                          state.view === "selection"
                            ? "bg-indigo-600"
                            : "bg-gray-700 hover:bg-gray-600"
                        } transition"
                        title="New Reading"
                    >
                        <i data-lucide="scan-face" class="w-5 h-5"></i>
                    </button>
                    <button 
                        onclick="setState({view: 'history', selectedHistoryItem: null})"
                        class="p-2 rounded-full ${
                          state.view === "history"
                            ? "bg-indigo-600"
                            : "bg-gray-700 hover:bg-gray-600"
                        } transition"
                        title="View History"
                    >
                        <i data-lucide="history" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <p class="text-xs text-center text-gray-500 mb-2">Local ID: ${userId}</p>
        `;
      }

      function renderFeatureScreen() {
        const currentCategory = allFaceFeatures[state.currentCategoryIndex];
        const currentFeature =
          currentCategory.features[state.currentFeatureIndex];

        const isFirstCategory = state.currentCategoryIndex === 0;
        const progress =
          (state.currentCategoryIndex / allFaceFeatures.length) * 100;

        let cardClass = "feature-card";
        if (state.cardAnimation) {
          cardClass += ` ${state.cardAnimation}`;
          setTimeout(() => {
            const cardElement = document.getElementById("feature-card");
            if (cardElement) {
              cardElement.classList.remove(state.cardAnimation);
              state.cardAnimation = null;
            }
          }, 10);
        }

        return `
            ${renderHeader()}
            <div class="space-y-6">
                <!-- Status -->
                <div class="text-center text-white">
                    <p class="text-sm font-medium text-indigo-400">Step ${
                      state.currentCategoryIndex + 1
                    } of ${allFaceFeatures.length}</p>
                    <h2 class="text-2xl font-bold mt-1">${
                      currentCategory.name
                    }</h2>
                    <p class="text-sm text-gray-400">${
                      currentCategory.description
                    }</p>
                    
                    ${
                      state.error
                        ? `
                        <div class="mt-4 flex items-center justify-center p-3 bg-red-800 border border-red-600 text-red-200 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                            <span class="text-sm font-medium">${state.error}</span>
                        </div>
                    `
                        : ""
                    }
                </div>

                <!-- Card Swiping Area -->
                <div class="flex justify-center relative">
                    <div id="feature-card" class="${cardClass} w-full max-w-xs bg-white rounded-2xl shadow-xl overflow-hidden p-0">
                        <!-- Image -->
                        <img 
                            src="${currentFeature.image}" 
                            alt="${currentFeature.name}" 
                            class="card-image w-full object-cover rounded-t-2xl"
                            onerror="this.onerror=null; this.src='https://placehold.co/300x300/cccccc/333333?text=Visual+Unavailable'"
                        >
                        <!-- Details -->
                        <div class="p-4">
                            <h3 class="text-xl font-bold text-gray-800">${
                              currentFeature.name
                            }</h3>
                            <p class="text-sm text-gray-600 mt-1">${
                              currentFeature.trait
                            }</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="pt-4 flex justify-center gap-6">
                    <button
                        onclick="handleSkip(false)"
                        class="card-button w-20 h-20 bg-gray-700 text-white rounded-full flex items-center justify-center hover:bg-gray-600 transform hover:scale-105"
                        title="Skip / Not a Match"
                    >
                        <i data-lucide="x" class="w-8 h-8 stroke-2"></i>
                    </button>
                    
                    <button
                        onclick="handleSelect(false)"
                        class="card-button w-20 h-20 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transform hover:scale-105"
                        title="Match / Select this Feature"
                    >
                        <i data-lucide="check" class="w-8 h-8 stroke-2"></i>
                    </button>
                </div>
                
                <!-- Undo & Progress -->
                <div class="mt-6 space-y-3">
                     <button
                        onclick="handleUndo()"
                        ${
                          isFirstCategory &&
                          Object.keys(state.finalSelections).length === 0
                            ? "disabled"
                            : ""
                        }
                        class="w-full py-2 bg-yellow-500 text-white font-bold rounded-full hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center space-x-2"
                    >
                        <i data-lucide="corner-up-left" class="w-5 h-5"></i>
                        <span>Undo Last Selection</span>
                    </button>

                    <!-- NEW SKIP ALL BUTTON -->
                    <button
                        onclick="handleSkipAll()"
                        class="w-full py-3 bg-red-600 text-white font-bold text-lg rounded-full hover:bg-red-700 transition flex items-center justify-center space-x-2 shadow-md"
                        title="Skips remaining features using the first option as default"
                    >
                        <i data-lucide="fast-forward" class="w-5 h-5"></i>
                        <span>Skip All & Analyze</span>
                    </button>
                    <!-- END NEW BUTTON -->

                    <div class="h-2 bg-gray-700 rounded-full overflow-hidden mt-4">
                        <div
                            class="h-full bg-indigo-500 transition-all duration-500 ease-out"
                            style="width: ${progress}%;"
                        ></div>
                    </div>
                </div>
            </div>
        `;
      }

      function renderReadingScreen() {
        const compiledReading = Object.entries(state.finalSelections)
          .map(([key, feature]) => {
            const category = allFaceFeatures.find((c) => c.key === key);
            const categoryName = category ? category.name : key;

            return `<div class="p-3 border-b border-gray-700 last:border-b-0">
                        <p class="text-lg font-semibold text-indigo-400">${categoryName}:</p>
                        <p class="text-white font-medium">${feature.name}</p>
                        <p class="text-gray-300 text-sm italic">${feature.trait}</p>
                    </div>`;
          })
          .join("");

        return `
            ${renderHeader()}
            <div class="text-center space-y-6 text-white">
                <h2 class="text-3xl font-extrabold text-green-500 flex items-center justify-center">
                    <i data-lucide="sparkles" class="w-8 h-8 mr-3"></i> Full Face Reading
                </h2>
                <p class="text-xl text-gray-300">Analysis Breakdown (${
                  Object.keys(state.finalSelections).length
                } Features Selected):</p>
                
                <!-- Saving indicator now reflects local saving status, which is near-instant -->
                <div class="flex items-center justify-center space-x-2 ${state.isSaving ? 'text-yellow-500' : 'text-green-500'}">
                    <i data-lucide="${state.isSaving ? 'loader-2 animate-spin' : 'check-circle'}" class="w-6 h-6"></i>
                    <span>Reading ${state.isSaving ? 'is saved' : 'saved'} successfully to local history!</span>
                </div>
                
                <!-- COPY BUTTON -->
                <button
                    onclick="copyReadingToClipboard(null)"
                    class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-indigo-800 text-indigo-100 text-sm font-semibold rounded-lg hover:bg-indigo-700 transition"
                >
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    <span>Copy Results to Clipboard</span>
                </button>

                <div class="bg-gray-800 p-6 rounded-xl text-left shadow-inner space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                    ${compiledReading}
                </div>

                <div class="flex flex-col space-y-4 pt-4">
                    <button
                        onclick="setState({view: 'selection', currentCategoryIndex: 0, currentFeatureIndex: 0, finalSelections: {}, error: null})"
                        class="w-full flex items-center justify-center space-x-2 px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition transform hover:scale-[1.01] active:scale-95"
                    >
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        <span>Start New Reading</span>
                    </button>
                    <button 
                        onclick="setState({view: 'history', selectedHistoryItem: null})"
                        class="w-full flex items-center justify-center space-x-2 px-6 py-3 bg-gray-700 text-gray-200 font-bold text-lg rounded-full shadow-lg hover:bg-gray-600 transition transform hover:scale-[1.01] active:scale-95"
                    >
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span>View All History</span>
                    </button>
                </div>
            </div>
        `;
      }

      function renderHistoryScreen() {
        if (state.history.length === 0) {
          return `
                ${renderHeader()}
                <div class="text-center p-8 text-white bg-gray-800 rounded-xl shadow-lg">
                    <i data-lucide="notebook-text" class="w-10 h-10 mx-auto text-gray-400 mb-4"></i>
                    <h3 class="text-2xl font-bold">No History Found</h3>
                    <p class="text-gray-400 mt-2">Start a new face reading to save your first profile!</p>
                    <button
                        onclick="setState({view: 'selection', currentCategoryIndex: 0, currentFeatureIndex: 0, finalSelections: {}, error: null})"
                        class="mt-6 w-full flex items-center justify-center space-x-2 px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition"
                    >
                        <i data-lucide="scan-face" class="w-5 h-5"></i>
                        <span>Start New Reading</span>
                    </button>
                </div>
            `;
        }

        const historyList = state.history
          .map((item) => {
            // item.createdAt is a string from local storage now
            const dateStr = item.createdAt;

            // Safely stringify the item for the onclick handler, replacing single quotes 
            // and using JSON.parse in the handler to convert it back to an object.
            const itemJson = JSON.stringify(item)
                // Escape backslashes first (for JSON string itself)
                .replace(/\\/g, '\\\\')
                // Escape single quotes for the surrounding 'onclick' attribute string
                .replace(/'/g, "\\'")
                // Replace double quotes with HTML entity &quot; 
                .replace(/"/g, '&quot;'); 

            return `
                <div 
                    onclick="setState({view: 'historyDetail', selectedHistoryItem: JSON.parse('${itemJson}')})"
                    class="p-4 bg-gray-800 rounded-lg shadow-md hover:bg-gray-700 transition cursor-pointer flex justify-between items-center"
                >
                    <div>
                        <p class="text-sm font-semibold text-indigo-300">Reading ID: ${item.id.substring(
                          0,
                          8
                        )}...</p>
                        <p class="text-sm text-gray-400">Captured on: ${dateStr}</p>
                        <p class="text-xs text-gray-500 mt-1">${item.summary.substring(
                          0,
                          70
                        )}...</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </div>
            `;
          })
          .join("");

        return `
            ${renderHeader()}
            <h2 class="text-2xl font-bold text-white mb-4">Reading History (${
              state.history.length
            })</h2>
            <div class="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar">
                ${historyList}
            </div>
        `;
      }

      function renderHistoryDetailScreen() {
        const item = state.selectedHistoryItem;
        if (!item) {
          return `<p class="text-white">Error: History item not selected.</p>`;
        }

        // item.createdAt is a string from local storage now
        const dateStr = item.createdAt;

        const compiledReading = Object.entries(item.selections)
          .map(([key, feature]) => {
            const category = allFaceFeatures.find((c) => c.key === key);
            const categoryName = category ? category.name : key;

            return `<div class="p-3 border-b border-gray-700 last:border-b-0">
                        <p class="text-lg font-semibold text-indigo-400">${categoryName}:</p>
                        <p class="text-white font-medium">${feature.name}</p>
                        <p class="text-gray-300 text-sm italic">${feature.trait}</p>
                    </div>`;
          })
          .join("");
          
        // Safely stringify the selections object for the copy button
        const selectionsJson = JSON.stringify(item.selections)
             .replace(/\\/g, '\\\\')
             .replace(/'/g, "\\'")
             .replace(/"/g, '&quot;');

        return `
            ${renderHeader()}
            <div class="flex justify-between items-center mb-4">
                <button
                    onclick="setState({view: 'history', selectedHistoryItem: null})"
                    class="flex items-center space-x-1 text-indigo-400 hover:text-indigo-300 transition"
                >
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>Back</span>
                </button>
                
                <!-- COPY BUTTON FOR HISTORY -->
                <button
                    onclick='copyReadingToClipboard(JSON.parse("${selectionsJson}"))'
                    class="flex items-center space-x-1 text-sm bg-indigo-800 px-3 py-1 rounded text-indigo-100 hover:bg-indigo-700 transition"
                >
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    <span>Copy</span>
                </button>
            </div>

            <h2 class="text-3xl font-extrabold text-white">Reading Details</h2>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg mt-4 space-y-2">
                <p class="text-sm text-gray-400">ID: <span class="text-white">${
                  item.id
                }</span></p>
                <p class="text-sm text-gray-400">Local User: <span class="text-white">${
                  item.userId
                }</span></p>
                <p class="text-sm text-gray-400">Date: <span class="text-white">${dateStr}</span></p>
            </div>

            <div class="mt-6 bg-gray-800 p-6 rounded-xl text-left shadow-inner space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Full Analysis</h3>
                ${compiledReading}
            </div>
            
            <button
                onclick="setState({view: 'selection', currentCategoryIndex: 0, currentFeatureIndex: 0, finalSelections: {}, error: null})"
                class="mt-6 w-full flex items-center justify-center space-x-2 px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition"
            >
                <i data-lucide="scan-face" class="w-5 h-5"></i>
                <span>Start New Reading</span>
            </button>
        `;
      }

      /**
       * Main render function that determines which screen to display.
       */
      function renderUI() {
        switch (state.view) {
          case "history":
            appDiv.innerHTML = renderHistoryScreen();
            break;
          case "historyDetail":
            appDiv.innerHTML = renderHistoryDetailScreen();
            break;
          case "reading":
            appDiv.innerHTML = renderReadingScreen();
            break;
          case "selection":
          default:
            appDiv.innerHTML = renderFeatureScreen();
            // Setup swipe events immediately after the feature card is rendered
            setupSwipeEvents();
            break;
        }

        // Re-render Lucide icons after inserting new HTML
        if (typeof lucide !== "undefined") {
          lucide.createIcons();
        }
      }

      // Initial application load (REPLACED initializeFirebase)
      window.onload = initializeApp;
    </script>
  </body>
</html>